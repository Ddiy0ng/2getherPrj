<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2GETHER</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous" />
  <style>
    .main {
      color: black;

      background-position: center;
      background-size: cover;

      background-color: white;
      /* 배경을 흰색으로 변경 */
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .mypostingbox>button {
      width: 100%;
    }

    .mypostingbox {
      width: 500px;
      margin: 20px auto 20px auto;

      border: 1px solid white;
      padding: 20px;
      border-radius: 5px;
    }

    #profile {
      display: flex;
      justify-content: center;
    }

    .card {
      width: 250px;
      height: 200px;
      margin-right: 10px;
    }

    .card>img {
      width: 100px;
      height: 100px;
      margin: 20px auto;
    }

    .card>.card-body {
      margin: 0 auto;
    }

    .guestbook-container {
      width: 70%;
      margin: 50px auto;
      padding: 30px;
      border: 2px solid rgb(123, 89, 45);
      border-radius: 15px;
      background-color: rgb(244, 236, 220);
      color: black;
    }

    .guestbook-title {
      color: rgb(123, 89, 45);
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 25px;
      text-align: center;
      border-bottom: 1px solid black;
      padding-bottom: 15px;
    }

    .form-group {
      width: 100%;
      margin-bottom: 10px;
      margin-left: auto;
      margin-right: auto;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: black;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      background-color: white;
      color: black;
      border-radius: 5px;
    }

    .btn-location {
      width: 100%;
    }

    .btn-submit {
      width: 100px;
      padding: 12px;
      border: 1px solid white;
      background-color: rgb(123, 89, 45);
      color: white;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
      margin-left: auto;
    }

    .btn-submit:hover {
      background-color: black;
      color: white;
      border-bottom: red;
    }

    .commentBox {
      background-color: white;
      width: 100%;
      margin-top: 40px;
      border: 1px solid rgb(171, 171, 171);
      border-radius: 5px;
      margin-left: auto;
      margin-right: auto;
    }

    .time {
      font-size: small;
      color: gray;
    }

    .pagination {
      margin-top: 5%;
      display: flex;
      justify-content: center;
    }

    .page-link {
      color: rgb(123, 89, 45);
    }
  </style>

  <script type="module">
    // Firebase SDK 라이브러리 가져오기
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"; // serverTimestamp import 추가

    // Firebase 구성 정보 설정
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyBpjDN7BhiyNBfu5a_2lHS88_YRqLKuG-w",
      authDomain: "sparta-e1dce.firebaseapp.com",
      projectId: "sparta-e1dce",
      storageBucket: "sparta-e1dce.firebasestorage.app",
      messagingSenderId: "1037901267217",
      appId: "1:1037901267217:web:b90b85f7c24c74ef530cb0",
      measurementId: "G-MYLSSH91WS"
    };


    // Firebase 인스턴스 초기화
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    $("#postingbtn").click(async function () {
      let image = $('#imageUrl').val();
      let name = $('#name').val();
      let age = $('#age').val();
      let blogLink = $('#blogLink').val();
      let hobby = $('#hobby').val();
      let intro = $('#intro').val();
      let tmi = $('#tmi').val();

      let doc = {
        'image': image,
        'name': name,
        'age': age,
        'blogLink': blogLink,
        'hobby': hobby,
        'intro': intro,
        'tmi': tmi
      };
      await addDoc(collection(db, "Intro"), doc);
      alert('저장 완료!');
      window.location.reload();
    })

    // 팀원 추가
    $("#savebtn").click(async function () {
      $("#postingbox").toggle();
      $("#profile").hide();
    });

    //   팀원 조회
    $("#selectbtn").click(async function () {
      $("#profile").toggle();
      $("#postingbox").hide();
    });

    let docs = await getDocs(collection(db, "Intro"));
    docs.forEach((doc) => {
      let row = doc.data();
      let docId = doc.id; //문서 ID 가져오기
      let image = row['image'];
      let name = row['name'];

      let temp_html = `
            <div class="card" style="cursor:pointer" onclick="location.href='2getherDetailPage.html?id=${docId}'">
                <img src="${image}" class="card-img-top" alt="profile img" />
                <div class="card-body">
                    <p class="card-text">${name}</p>
                </div>
            </div>`;
      $('#profile').append(temp_html);
    });


    // 방명록 등록 기능
    let guestbookData = [];
    let pageNum = 1;

    // 방명록 등록 기능
    $("#guestSubmit").click(async function () {
      let name = $("#guestName").val();
      let content = $("#guestContent").val();

      if (name.trim() === "" || content.trim() === "") {
        alert("이름과 내용을 모두 입력해주세요!");
        return;
      }

      let doc = {
        name: name,
        content: content,
        timestamp: serverTimestamp()
      };

      await addDoc(collection(db, "guestbook"), doc);
      alert("방명록이 저장되었습니다!");
      $("#guestName").val("");
      $("#guestContent").val("");

      getGuestbookCount(); //방명록 개수 세기
      getGuestbook();  // 데이터를 다시 불러오기
    });

    // 방명록 개수
    async function getGuestbookCount() {
      const querySnapshot = await getDocs(collection(db, "guestbook"));
      const count = querySnapshot.size;  // 컬렉션의 문서 수를 가져옴
      $("#message").text(count);  // 방명록 수 표시
    }

    // 방명록 데베에서 로드
    async function getGuestbook() {
      const querySnapshot = await getDocs(collection(db, "guestbook"));
      guestbookData = [];

      querySnapshot.forEach((doc) => {
        let data = doc.data();
        guestbookData.push({
          ...data,
          id: doc.id // 문서 ID도 함께 저장
        });
      });
      // timestamp 기준으로 내림차순 정렬
      guestbookData.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);  // 서버 timestamp 비교

      displayGuestbookData();
      pagination_add();  // 페이지네이션 추가
    }


    // 방명록 출력
    function displayGuestbookData() {
      let commentList = guestbookData.slice((pageNum - 1) * 5, pageNum * 5);
      $("#guestList .commentBox").remove();// 기존의 방명록 없애기_다시 출력할꺼니까

      let html = "";
      commentList.forEach((data) => {
        html += `
                    <div class="commentBox">
                        <strong>${data.name}</strong><br/>
                        <p>${data.content}</p>
                        <p class="time">${data.timestamp.toDate().toLocaleString()}</p>
                    </div>
                `;
      });
      $("#guestList").append(html);
    }


    // 페이지네이션 추가
    function pagination_add() {
      const pages = Math.ceil(guestbookData.length / 5);
      let html = "";

      // 페이지네이션 버튼 추가
      for (let i = 0; i < pages; i++) {
        html += `
                    <li class="page-item">
                        <a class="page-link" href="#">${i + 1}</a>
                    </li>
                `;
      }

      $(".pagination").html(html);  // 페이지네이션을 추가
    }

    // 페이지네이션 버튼 클릭, 방명록 출력
    $(document).on('click', '.page-link', function (event) {
      pageNum = parseInt($(this).text());  // 클릭한 페이지 번호
      displayGuestbookData();  // 해당 페이지의 방명록 출력
    });

    $(document).ready(function () {
      // 데베 로드
      getGuestbook();

      // 개수 카운트
      getGuestbookCount();
    });
  </script>
</head>

<body>
  <div class="main">
    <div class="p-5 mb-4 bg-body-tertiary rounded-3">
      <div class="container-fluid py-5">
        <h1 class="display-5 fw-bold">2GETHER</h1>
        <p class="col-md-8 fs-4 mx-auto">
          공부도 과제도 고민도 함께하는 2조 2gether입니다. 각기 다른 개성과
          능력을 가진 팀원들이 하나의 목표를 향해 나아간다는 의미를 담고
          있습니다.
        </p>
        <button id="savebtn" type="button" class="btn btn-outline-dark">
          팀원 추가
        </button>
        <button id="selectbtn" type="button" class="btn btn-outline-dark">
          팀원 조회
        </button>
      </div>
    </div>
  </div>

  <!-- 팀원 추가 -->
  <div class="mypostingbox" id="postingbox">
    <div class="form-floating mb-3">
      <input type="email" class="form-control" id="imageUrl" placeholder="본인 이미지 주소" />
      <label for="floatingInput">이미지</label>
    </div>
    <div class="form-floating mb-3">
      <input type="email" class="form-control" id="name" placeholder="이름" />
      <label for="floatingInput">이름</label>
    </div>
    <div class="form-floating mb-3">
      <input type="email" class="form-control" id="age" placeholder="나이" />
      <label for="floatingInput">나이</label>
    </div>
    <div class="form-floating mb-3">
      <input type="email" class="form-control" id="blogLink" placeholder="블로그 링크" />
      <label for="floatingInput">블로그 링크</label>
    </div>
    <div class="form-floating mb-3">
      <input type="email" class="form-control" id="hobby" placeholder="취미" />
      <label for="floatingInput">취미</label>
    </div>
    <div class="form-floating mb-3">
      <input type="email" class="form-control" id="intro" placeholder="한 줄 자기소개" />
      <label for="floatingInput">한 줄 자기소개</label>
    </div>
    <div class="form-floating mb-3">
      <input type="email" class="form-control" id="tmi" placeholder="TMI" />
      <label for="floatingInput">TMI</label>
    </div>
    <button id="postingbtn" type="button" class="btn btn-danger">
      팀원 추가하기
    </button>
  </div>

  <!-- 팀원 조회 -->
  <div id="profile" style="display: none">
  </div>

  <div class="guestbook-container">
    <div class="guestbook-title">방명록</div>

    <div class="form-group">
      <label for="guestName">이름</label>
      <input type="text" id="guestName" placeholder="이름을 입력하세요">
    </div>
    <div class="form-group">
      <label for="guestContent">방명록 내용</label>
      <textarea id="guestContent" rows="3" placeholder="내용을 입력하세요"></textarea>
    </div>
    <div class="btn-location">
      <div class="btn-submit" id="guestSubmit">등록하기</div>
    </div>
    <hr>
    <p>방명록 수: <span id="message">?</span></p>
    <div id="guestList" style="margin-top: 30px;"></div>

    <div class="pagination-location">
      <nav aria-label="Page navigation example">
        <ul class="pagination">
        </ul>
      </nav>
    </div>


  </div>
</body>

</html>